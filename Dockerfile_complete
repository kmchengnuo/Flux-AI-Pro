# === AI Image Generator - Complete Production Dockerfile ===
# ä½¿ç”¨å®˜æ–¹Python 3.11é•œåƒä½œä¸ºåŸºç¡€
FROM python:3.11-slim

# è®¾ç½®ç»´æŠ¤è€…ä¿¡æ¯
LABEL maintainer="AI Image Generator Team"
LABEL description="Complete AI Image Generator with Multi-Model Support"
LABEL version="2.0.0"

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    APP_HOME=/app \
    STREAMLIT_SERVER_PORT=8501 \
    STREAMLIT_SERVER_ADDRESS=0.0.0.0 \
    STREAMLIT_SERVER_HEADLESS=true \
    STREAMLIT_BROWSER_GATHER_USAGE_STATS=false \
    STREAMLIT_SERVER_ENABLE_CORS=false \
    STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION=false

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    # åŸºç¡€å·¥å…·
    curl \
    wget \
    git \
    # å›¾åƒå¤„ç†åº“
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libglib2.0-dev \
    # OpenCVä¾èµ–
    libgl1-mesa-glx \
    libgthread-2.0-0 \
    # ç½‘ç»œå·¥å…·
    ca-certificates \
    # æ¸…ç†å®‰è£…ç¼“å­˜
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# åˆ›å»ºéç‰¹æƒç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser -d $APP_HOME -s /sbin/nologin -c "App User" appuser

# åˆ›å»ºåº”ç”¨ç›®å½•
RUN mkdir -p $APP_HOME && chown -R appuser:appuser $APP_HOME

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR $APP_HOME

# å…ˆå¤åˆ¶requirementsæ–‡ä»¶ä»¥åˆ©ç”¨Dockerç¼“å­˜
COPY requirements_complete.txt requirements.txt

# å‡çº§pipå¹¶å®‰è£…Pythonä¾èµ–
RUN pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY app_complete.py app.py
COPY secrets_example.toml secrets_example.toml
COPY README_Enhanced.md README.md

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p .streamlit && \
    mkdir -p data && \
    mkdir -p logs && \
    mkdir -p temp

# åˆ›å»ºStreamlité…ç½®æ–‡ä»¶
RUN echo '\
[server]\n\
port = 8501\n\
address = "0.0.0.0"\n\
headless = true\n\
enableCORS = false\n\
enableXsrfProtection = false\n\
\n\
[browser]\n\
gatherUsageStats = false\n\
\n\
[theme]\n\
primaryColor = "#FF6B6B"\n\
backgroundColor = "#FFFFFF"\n\
secondaryBackgroundColor = "#F0F2F6"\n\
textColor = "#262730"\n\
' > .streamlit/config.toml

# è®¾ç½®æ–‡ä»¶æƒé™
RUN chown -R appuser:appuser $APP_HOME && \
    chmod +x app.py

# åˆ‡æ¢åˆ°éç‰¹æƒç”¨æˆ·
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8501

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "========================================"\n\
echo "ğŸ¨ AI Image Generator Starting..."\n\
echo "Version: 2.0.0"\n\
echo "Port: ${STREAMLIT_SERVER_PORT}"\n\
echo "========================================"\n\
\n\
# æ£€æŸ¥ç¯å¢ƒ\n\
echo "âš™ï¸ Checking environment..."\n\
if [ -z "$STREAMLIT_SERVER_PORT" ]; then\n\
    export STREAMLIT_SERVER_PORT=8501\n\
fi\n\
\n\
if [ -z "$STREAMLIT_SERVER_ADDRESS" ]; then\n\
    export STREAMLIT_SERVER_ADDRESS=0.0.0.0\n\
fi\n\
\n\
# æ£€æŸ¥é…ç½®æ–‡ä»¶\n\
echo "ğŸ“ Checking configuration..."\n\
if [ ! -f ".streamlit/secrets.toml" ] && [ -n "$STREAMLIT_SECRETS" ]; then\n\
    echo "ğŸ”‘ Creating secrets from environment..."\n\
    echo "$STREAMLIT_SECRETS" > .streamlit/secrets.toml\n\
fi\n\
\n\
# æ£€æŸ¥ç½‘ç»œè¿æ¥\n\
echo "ğŸŒ Testing network connectivity..."\n\
if ! curl -s --connect-timeout 5 https://httpbin.org/status/200 > /dev/null; then\n\
    echo "âš ï¸ Warning: Network connectivity issues detected"\n\
else\n\
    echo "âœ… Network connectivity OK"\n\
fi\n\
\n\
# æ£€æŸ¥ç£ç›˜ç©ºé—´\n\
echo "ğŸ’¾ Checking disk space..."\n\
df -h /\n\
\n\
# æ£€æŸ¥å†…å­˜\n\
echo "ğŸ“¦ Checking memory..."\n\
free -h\n\
\n\
echo "========================================"\n\
echo "ğŸš€ Starting Streamlit application..."\n\
echo "========================================"\n\
\n\
# å¯åŠ¨åº”ç”¨\n\
exec streamlit run app.py \\\
    --server.port=$STREAMLIT_SERVER_PORT \\\
    --server.address=$STREAMLIT_SERVER_ADDRESS \\\
    --server.headless=true \\\
    --browser.gatherUsageStats=false \\\
    --server.enableCORS=false \\\
    --server.enableXsrfProtection=false\n\
' > start.sh && chmod +x start.sh

# è®¾ç½®é»˜è®¤å‘½ä»¤
CMD ["./start.sh"]

# === æ„å»ºå’Œéƒ¨ç½²è¯´æ˜ ===
# 
# æ„å»ºå‘½ä»¤:
# docker build -f Dockerfile_complete -t ai-image-generator:latest .
#
# è¿è¡Œå‘½ä»¤:
# docker run -p 8501:8501 ai-image-generator:latest
#
# ä½¿ç”¨ç¯å¢ƒå˜é‡Secrets:
# docker run -p 8501:8501 -e STREAMLIT_SECRETS="$(cat .streamlit/secrets.toml)" ai-image-generator:latest
#
# ä½¿ç”¨æ•°æ®å·:
# docker run -p 8501:8501 -v $(pwd)/data:/app/data ai-image-generator:latest
#
# Docker Compose ç¤ºä¾‹:
# version: '3.8'
# services:
#   ai-image-generator:
#     image: ai-image-generator:latest
#     ports:
#       - "8501:8501"
#     environment:
#       - STREAMLIT_SECRETS=${STREAMLIT_SECRETS}
#     volumes:
#       - ./data:/app/data
#       - ./logs:/app/logs
#     restart: unless-stopped
#     healthcheck:
#       test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
#       interval: 30s
#       timeout: 10s
#       retries: 3
